import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Loader2,
  Sparkles,
  Download,
  FileText,
  Languages,
  Wand2,
  CheckCircle2,
  AlertTriangle,
  Trash2,
  Copy,
} from "lucide-react";

/**
 * ƒå√çTANIE S POROZUMEN√çM ‚Äì GENER√ÅTOR (MVP)
 *
 * ‚úÖ UI: jazyk (EN/DE/FR/Vlastn√Ω), CEFR, dƒ∫≈æka, t√©ma, cieƒæov√° slovn√° z√°soba (tagy), prep√≠naƒç cviƒçen√≠,
 *    checkboxy typov cviƒçen√≠, generovanie kƒæ√∫ƒça, export (PDF/DOCX) ‚Äì uk√°≈ækov√© stub tlaƒçidl√°.
 * ‚úÖ Generovanie: pou≈æ√≠va lok√°lny "mock" gener√°tor ‚Äì pripraven√© na napojenie na LLM API.
 * ‚úÖ Profesion√°lny vzhƒæad: modern√© karty, jemn√© anim√°cie, prehƒæadn√Ω layout.
 *
 * üîå Ako napoji≈• na LLM:
 * - v handleGenerate() nahraƒè mockGenerate(...) volan√≠m na vlastn√Ω endpoint (/api/generate)
 * - endpoint zavol√° LLM (napr. OpenAI) a vr√°ti JSON: { passage, vocabulary, exercises, answerKey }
 *
 * üìÑ Export PDF/DOCX:
 * - v handleExport(...) integruj napr.:
 *   - PDF: @react-pdf/renderer alebo server-side (Puppeteer)
 *   - DOCX: docx (npm) alebo server-side templating
 */

const LANG_PRESETS = [
  { value: "en", label: "English" },
  { value: "de", label: "Deutsch" },
  { value: "fr", label: "Fran√ßais" },
  { value: "custom", label: "Vlastn√Ω jazyk" },
] as const;

const CEFR_LEVELS = ["A1", "A2", "B1", "B2", "C1", "C2"] as const;

const EXERCISE_TYPES = [
  { key: "matching", label: "Sp√°jaƒçky" },
  { key: "gapfill", label: "Dopl≈àovaƒçky" },
  { key: "mcq", label: "V√Ωber z mo≈ænost√≠" },
  { key: "open", label: "Otvoren√© ot√°zky" },
  { key: "discussion", label: "Ot√°zky do diskusie" },
] as const;

type ExerciseKey = (typeof EXERCISE_TYPES)[number]["key"];

type Generated = {
  title: string;
  languageLabel: string;
  topic: string;
  cefr: string;
  lengthWords: number;
  vocabulary: string[];
  passage: string;
  exercises?: Record<ExerciseKey, any>;
  answerKey?: Record<ExerciseKey, any>;
};

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function uniq(arr: string[]) {
  return Array.from(new Set(arr.map((s) => s.trim()).filter(Boolean)));
}

function splitToTags(raw: string) {
  // rozdel√≠ podƒæa ƒçiarky, bodkoƒçiarky alebo nov√©ho riadku
  return uniq(
    raw
      .split(/[,;\n]+/)
      .map((s) => s.trim())
      .filter(Boolean)
  );
}

function estimateWordsFromLength(length: string) {
  // "very short" -> 90, "short" -> 140, "medium" -> 200, "long" -> 280
  switch (length) {
    case "very_short":
      return 90;
    case "short":
      return 140;
    case "medium":
      return 200;
    case "long":
      return 280;
    case "very_long":
      return 380;
    default:
      return 200;
  }
}

function prettyLang(value: string, custom: string) {
  if (value === "en") return "English";
  if (value === "de") return "Deutsch";
  if (value === "fr") return "Fran√ßais";
  return custom?.trim() ? custom.trim() : "Vlastn√Ω jazyk";
}

function buildPrompt(params: {
  language: string;
  customLanguage: string;
  cefr: string;
  length: string;
  topic: string;
  vocabTags: string[];
  autoVocab: boolean;
  wantExercises: boolean;
  exerciseTypes: ExerciseKey[];
}) {
  const lang = prettyLang(params.language, params.customLanguage);
  const words = estimateWordsFromLength(params.length);
  const vocabLine = params.autoVocab
    ? "Vyber vhodn√∫ cieƒæov√∫ slovn√∫ z√°sobu s√°m podƒæa t√©my (10‚Äì16 slov)."
    : `Pou≈æi presne tieto cieƒæov√© slov√≠ƒçka: ${params.vocabTags.join(", ")}.`;

  const exLine = params.wantExercises
    ? `Pridaj cviƒçenia: ${params.exerciseTypes
        .map((k) => EXERCISE_TYPES.find((x) => x.key === k)?.label)
        .filter(Boolean)
        .join(", ")}. Pridaj aj kƒæ√∫ƒç odpoved√≠.`
    : "Cviƒçenia neprid√°vaj.";

  return `Si sk√∫sen√Ω uƒçiteƒæ cudz√≠ch jazykov a tvorca uƒçebn√Ωch materi√°lov.\n\nVygeneruj text na ƒç√≠tanie s porozumen√≠m v jazyku: ${lang}.\nCEFR √∫rove≈à: ${params.cefr}.\nT√©ma: ${params.topic || "(nezadan√©)"}.\nDƒ∫≈æka: pribli≈æne ${words} slov.\n\n${vocabLine}\n\nZadanie:\n1) Vytvor n√°zov.\n2) Nap√≠≈° text v 2‚Äì4 odsekoch, prirodzen√Ω jazyk vhodn√Ω pre √∫rove≈à.\n3) Potom uveƒè zoznam cieƒæovej slovnej z√°soby (10‚Äì16 polo≈æiek).\n4) ${exLine}\n\nForm√°tuj ƒçisto a prehƒæadne.`;
}

/**
 * Mock generovanie (bez API). √öƒçel: UI demo + ≈°trukt√∫ra v√Ωstupu.
 * Nahraditeƒæn√© volan√≠m serveru.
 */
async function mockGenerate(input: {
  language: string;
  customLanguage: string;
  cefr: string;
  length: string;
  topic: string;
  vocabTags: string[];
  autoVocab: boolean;
  wantExercises: boolean;
  exerciseTypes: ExerciseKey[];
}): Promise<Generated> {
  await new Promise((r) => setTimeout(r, 900));

  const langLabel = prettyLang(input.language, input.customLanguage);
  const lengthWords = estimateWordsFromLength(input.length);

  const seedVocab = [
    "habit",
    "challenge",
    "improve",
    "focus",
    "routine",
    "notice",
    "support",
    "goal",
    "progress",
    "feedback",
    "curious",
    "strategy",
    "practice",
    "confidence",
    "collaboration",
  ];

  const vocab = input.autoVocab
    ? seedVocab
        .slice(0, clamp(Math.round(lengthWords / 20), 10, 16))
        .map((w) => w.toLowerCase())
    : input.vocabTags;

  const topic = input.topic?.trim() || "Daily life and learning";

  const title = `Reading: ${topic}`;

  const baseText =
    langLabel === "Deutsch"
      ? `Heute m√∂chte ich dir eine kurze Geschichte √ºber ‚Äû${topic}‚Äú erz√§hlen. Sie zeigt, wie kleine Gewohnheiten gro√üe Ver√§nderungen bringen k√∂nnen.\n\nAm Anfang war alles chaotisch, aber dann hat Mia angefangen, jeden Tag zehn Minuten zu √ºben. Sie hat nicht alles sofort verstanden, doch sie blieb neugierig und hat nach Feedback gefragt.\n\nMit der Zeit wurde sie sicherer. Sie merkte, dass eine klare Routine hilft, stressige Momente zu meistern. Am Ende hat sie sogar ihre Freunde motiviert, zusammen zu lernen.`
      : langLabel === "Fran√ßais"
      ? `Aujourd‚Äôhui, je vais te raconter une courte histoire sur ¬´ ${topic} ¬ª. Elle montre comment de petites habitudes peuvent changer beaucoup de choses.\n\nAu d√©but, tout semblait difficile, puis Mia a commenc√© √† pratiquer dix minutes par jour. Elle ne comprenait pas tout tout de suite, mais elle est rest√©e curieuse et a demand√© du feedback.\n\nAvec le temps, elle a gagn√© en confiance. Elle a remarqu√© qu‚Äôune routine claire aide √† g√©rer le stress. Finalement, elle a m√™me motiv√© ses amis √† apprendre ensemble.`
      : langLabel === "English"
      ? `Today I want to share a short story about ‚Äú${topic}‚Äù. It shows how small habits can create big changes.\n\nAt first, everything felt messy, but then Mia started to practise for ten minutes every day. She didn‚Äôt understand everything immediately, yet she stayed curious and asked for feedback.\n\nOver time, she became more confident. She noticed that a clear routine helps in stressful moments. In the end, she even motivated her friends to learn together.`
      : `Text in ${langLabel}: A short reading about ‚Äú${topic}‚Äù.\n\nMia tries a new routine. She practises a little each day, asks for feedback, and feels more confident.\n\nIn the end, she shares her strategy with friends and they collaborate.`;

  // pribli≈æn√° √∫prava dƒ∫≈æky ‚Äì len pre demo
  const fillerSentence =
    langLabel === "Deutsch"
      ? " Sie macht kleine Schritte und sieht jeden Tag Fortschritt."
      : langLabel === "Fran√ßais"
      ? " Elle fait de petits pas et voit des progr√®s chaque jour."
      : langLabel === "English"
      ? " She takes small steps and sees progress every day."
      : " Small steps bring visible progress each day.";

  const target = lengthWords;
  const wordsNow = baseText.split(/\s+/).length;
  const extra = clamp(Math.round((target - wordsNow) / 12), 0, 18);
  const passage =
    baseText +
    (extra > 0
      ? "\n\n" + new Array(extra).fill(fillerSentence).join("")
      : "");

  let exercises: any = undefined;
  let answerKey: any = undefined;

  if (input.wantExercises && input.exerciseTypes.length) {
    exercises = {};
    answerKey = {};

    if (input.exerciseTypes.includes("matching")) {
      const pairs = vocab.slice(0, 8).map((w, i) => ({
        term: w,
        def: `Definition ${i + 1} (demo)`
      }));
      exercises.matching = {
        instruction:
          "Match the words to the definitions (demo content).",
        pairs,
      };
      answerKey.matching = {
        matches: pairs.map((p) => ({ term: p.term, def: p.def })),
      };
    }

    if (input.exerciseTypes.includes("gapfill")) {
      const blanks = vocab.slice(0, 8);
      exercises.gapfill = {
        instruction:
          "Complete the sentences with the correct word (demo content).",
        items: blanks.map((w, i) => ({
          sentence: `Sentence ${i + 1}: I will ____ today.`,
          options: blanks.slice(0, 4),
        })),
      };
      answerKey.gapfill = {
        answers: blanks.map((w, i) => ({ index: i + 1, answer: w })),
      };
    }

    if (input.exerciseTypes.includes("mcq")) {
      exercises.mcq = {
        instruction: "Choose the best answer (demo content).",
        items: [
          {
            q: "What is the main idea of the text?",
            options: [
              "Big changes need big actions",
              "Small habits can create progress",
              "Learning is always easy",
              "Routine never helps",
            ],
          },
        ],
      };
      answerKey.mcq = { answers: [{ index: 1, answer: 2 }] };
    }

    if (input.exerciseTypes.includes("open")) {
      exercises.open = {
        instruction: "Answer in 1‚Äì2 sentences (demo content).",
        questions: [
          "What did Mia change in her routine?",
          "How did she feel over time?",
        ],
      };
      answerKey.open = {
        sample: [
          "She started practising for a short time every day.",
          "She became more confident and managed stress better.",
        ],
      };
    }

    if (input.exerciseTypes.includes("discussion")) {
      exercises.discussion = {
        instruction: "Discuss with a partner (demo content).",
        prompts: [
          "What habit would help you learn better?",
          "How do you like to get feedback?",
        ],
      };
      answerKey.discussion = { note: "No fixed answers." };
    }
  }

  return {
    title,
    languageLabel: langLabel,
    topic,
    cefr: input.cefr,
    lengthWords,
    vocabulary: vocab,
    passage,
    exercises,
    answerKey,
  };
}

function SectionTitle({ icon: Icon, title }: any) {
  return (
    <div className="flex items-center gap-2">
      <div className="rounded-2xl bg-muted p-2">
        <Icon className="h-4 w-4" />
      </div>
      <h3 className="text-sm font-semibold tracking-tight">{title}</h3>
    </div>
  );
}

function ChipInput({
  value,
  onChange,
  tags,
  setTags,
  placeholder,
}: {
  value: string;
  onChange: (v: string) => void;
  tags: string[];
  setTags: (t: string[]) => void;
  placeholder?: string;
}) {
  const inputRef = useRef<HTMLInputElement | null>(null);

  useEffect(() => {
    // ak pou≈æ√≠vateƒæ nap√≠≈°e ƒçiarku, okam≈æite premeni≈• na tagy
    if (value.includes(",") || value.includes(";") || value.includes("\n")) {
      const newTags = splitToTags(value);
      if (newTags.length) {
        setTags(uniq([...tags, ...newTags]));
        onChange("");
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [value]);

  const removeTag = (t: string) => {
    setTags(tags.filter((x) => x !== t));
    requestAnimationFrame(() => inputRef.current?.focus());
  };

  return (
    <div className="space-y-2">
      <div className="flex flex-wrap gap-2">
        {tags.map((t) => (
          <Badge
            key={t}
            variant="secondary"
            className="rounded-2xl px-3 py-1 text-sm"
          >
            <span className="mr-2">{t}</span>
            <button
              onClick={() => removeTag(t)}
              className="opacity-70 hover:opacity-100"
              aria-label={`Remove ${t}`}
            >
              √ó
            </button>
          </Badge>
        ))}
      </div>
      <Input
        ref={inputRef}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder || "Zadaj slov√≠ƒçka oddelen√© ƒçiarkou‚Ä¶"}
      />
    </div>
  );
}

function formatWorksheet(gen: Generated) {
  const lines: string[] = [];
  lines.push(gen.title);
  lines.push("");
  lines.push(`Language: ${gen.languageLabel}`);
  lines.push(`CEFR: ${gen.cefr} ¬∑ Target length: ~${gen.lengthWords} words`);
  lines.push(`Topic: ${gen.topic}`);
  lines.push("");
  lines.push("TEXT");
  lines.push(gen.passage);
  lines.push("");
  lines.push("VOCABULARY");
  lines.push(gen.vocabulary.map((w, i) => `${i + 1}. ${w}`).join("\n"));

  if (gen.exercises) {
    lines.push("");
    lines.push("EXERCISES");
    for (const [k, payload] of Object.entries(gen.exercises)) {
      const label = EXERCISE_TYPES.find((x) => x.key === k)?.label || k;
      lines.push("");
      lines.push(label.toUpperCase());
      lines.push(payload.instruction || "");
      if (k === "matching") {
        lines.push(
          payload.pairs
            .map((p: any, i: number) => `${i + 1}) ${p.term}  ‚Äî  ____`)
            .join("\n")
        );
        lines.push("\nDefinitions:");
        lines.push(payload.pairs.map((p: any, i: number) => `${String.fromCharCode(65 + i)}) ${p.def}`).join("\n"));
      }
      if (k === "gapfill") {
        lines.push(payload.items.map((it: any, i: number) => `${i + 1}) ${it.sentence}`).join("\n"));
        lines.push("\nWord bank:");
        const bank = Array.from(new Set(payload.items.flatMap((it: any) => it.options || [])));
        lines.push(bank.join(", "));
      }
      if (k === "mcq") {
        lines.push(
          payload.items
            .map((it: any, i: number) =>
              `${i + 1}) ${it.q}\n   ${it.options
                .map((o: string, j: number) => `${String.fromCharCode(65 + j)}) ${o}`)
                .join("\n   ")}`
            )
            .join("\n\n")
        );
      }
      if (k === "open") {
        lines.push(payload.questions.map((q: string, i: number) => `${i + 1}) ${q}`).join("\n"));
      }
      if (k === "discussion") {
        lines.push(payload.prompts.map((q: string, i: number) => `${i + 1}) ${q}`).join("\n"));
      }
    }

    if (gen.answerKey) {
      lines.push("");
      lines.push("ANSWER KEY");
      for (const [k, payload] of Object.entries(gen.answerKey)) {
        const label = EXERCISE_TYPES.find((x) => x.key === k)?.label || k;
        lines.push("");
        lines.push(label.toUpperCase());
        lines.push(JSON.stringify(payload, null, 2));
      }
    }
  }

  return lines.join("\n");
}

export default function ReadingComprehensionGeneratorApp() {
  const [language, setLanguage] = useState<(typeof LANG_PRESETS)[number]["value"]>(
    "en"
  );
  const [customLanguage, setCustomLanguage] = useState("");

  const [cefr, setCefr] = useState<(typeof CEFR_LEVELS)[number]>("B1");
  const [length, setLength] = useState<
    "very_short" | "short" | "medium" | "long" | "very_long"
  >("medium");

  const [topic, setTopic] = useState("Teen life and wellbeing");

  const [autoVocab, setAutoVocab] = useState(true);
  const [vocabRaw, setVocabRaw] = useState("");
  const [vocabTags, setVocabTags] = useState<string[]>([]);

  const [wantExercises, setWantExercises] = useState(false);
  const [exerciseTypes, setExerciseTypes] = useState<ExerciseKey[]>([
    "mcq",
    "open",
  ]);

  const [isLoading, setIsLoading] = useState(false);
  const [generated, setGenerated] = useState<Generated | null>(null);
  const [error, setError] = useState<string | null>(null);

  const [promptOpen, setPromptOpen] = useState(false);

  const langLabel = useMemo(
    () => prettyLang(language, customLanguage),
    [language, customLanguage]
  );

  const computedPrompt = useMemo(() =>
    buildPrompt({
      language,
      customLanguage,
      cefr,
      length,
      topic,
      vocabTags,
      autoVocab,
      wantExercises,
      exerciseTypes,
    }),
  [language, customLanguage, cefr, length, topic, vocabTags, autoVocab, wantExercises, exerciseTypes]);

  const toggleExercise = (key: ExerciseKey) => {
    setExerciseTypes((prev) =>
      prev.includes(key) ? prev.filter((k) => k !== key) : [...prev, key]
    );
  };

  const canGenerate = useMemo(() => {
    if (language === "custom" && !customLanguage.trim()) return false;
    if (!topic.trim()) return false;
    if (!autoVocab && vocabTags.length === 0) return false;
    if (wantExercises && exerciseTypes.length === 0) return false;
    return true;
  }, [language, customLanguage, topic, autoVocab, vocabTags, wantExercises, exerciseTypes]);

  async function handleGenerate() {
    setError(null);
    setIsLoading(true);
    try {
      const data = await mockGenerate({
        language,
        customLanguage,
        cefr,
        length,
        topic,
        vocabTags,
        autoVocab,
        wantExercises,
        exerciseTypes,
      });
      setGenerated(data);
    } catch (e: any) {
      setError("Nepodarilo sa vygenerova≈• obsah. Sk√∫s to pros√≠m e≈°te raz.");
    } finally {
      setIsLoading(false);
    }
  }

  function handleCopy() {
    if (!generated) return;
    const txt = formatWorksheet(generated);
    navigator.clipboard.writeText(txt);
  }

  function handleClear() {
    setGenerated(null);
    setError(null);
  }

  function handleExport(kind: "pdf" | "docx") {
    // MVP: stiahnutie ako .txt (placeholder). V produkcii to nahraƒè re√°lnym exportom.
    if (!generated) return;
    const content = formatWorksheet(generated);
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${(generated.title || "worksheet").replace(/[^a-z0-9\-_ ]/gi, "").trim().replace(/\s+/g, "-").toLowerCase()}.${kind}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="min-h-screen w-full bg-background">
      <div className="mx-auto max-w-6xl px-4 py-8">
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-6 flex flex-col gap-2"
        >
          <div className="flex items-center gap-3">
            <div className="rounded-2xl bg-muted p-2">
              <Languages className="h-5 w-5" />
            </div>
            <h1 className="text-2xl font-semibold tracking-tight">
              Gener√°tor ƒç√≠tania s porozumen√≠m
            </h1>
            <Badge variant="secondary" className="rounded-2xl">
              MVP
            </Badge>
          </div>
          <p className="text-muted-foreground">
            Vyber jazyk, √∫rove≈à, dƒ∫≈æku, t√©mu, slovn√∫ z√°sobu a voliteƒæn√© cviƒçenia.
            V√Ωstup m√¥≈æe≈° stiahnu≈• ako PDF alebo DOCX (v MVP ako placeholder export).
          </p>
        </motion.div>

        <div className="grid grid-cols-1 gap-6 lg:grid-cols-2">
          {/* LEFT: SETTINGS */}
          <Card className="rounded-2xl shadow-sm">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-base">
                <Wand2 className="h-4 w-4" /> Nastavenia generovania
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label>Jazyk</Label>
                  <Select
                    value={language}
                    onValueChange={(v: any) => setLanguage(v)}
                  >
                    <SelectTrigger className="rounded-2xl">
                      <SelectValue placeholder="Vyber jazyk" />
                    </SelectTrigger>
                    <SelectContent>
                      {LANG_PRESETS.map((l) => (
                        <SelectItem key={l.value} value={l.value}>
                          {l.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>CEFR √∫rove≈à</Label>
                  <Select value={cefr} onValueChange={(v: any) => setCefr(v)}>
                    <SelectTrigger className="rounded-2xl">
                      <SelectValue placeholder="Vyber √∫rove≈à" />
                    </SelectTrigger>
                    <SelectContent>
                      {CEFR_LEVELS.map((l) => (
                        <SelectItem key={l} value={l}>
                          {l}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Dƒ∫≈æka textu</Label>
                  <Select value={length} onValueChange={(v: any) => setLength(v)}>
                    <SelectTrigger className="rounded-2xl">
                      <SelectValue placeholder="Vyber dƒ∫≈æku" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="very_short">Veƒæmi kr√°tky (~90)</SelectItem>
                      <SelectItem value="short">Kr√°tky (~140)</SelectItem>
                      <SelectItem value="medium">Stredn√Ω (~200)</SelectItem>
                      <SelectItem value="long">Dlh√Ω (~280)</SelectItem>
                      <SelectItem value="very_long">Veƒæmi dlh√Ω (~380)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>T√©ma</Label>
                  <Input
                    className="rounded-2xl"
                    value={topic}
                    onChange={(e) => setTopic(e.target.value)}
                    placeholder="Napr. Animals, School life, Space‚Ä¶"
                  />
                </div>
              </div>

              <AnimatePresence>
                {language === "custom" && (
                  <motion.div
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: "auto" }}
                    exit={{ opacity: 0, height: 0 }}
                    className="space-y-2"
                  >
                    <Label>Vlastn√Ω jazyk (nap√≠≈° cieƒæov√Ω jazyk)</Label>
                    <Input
                      className="rounded-2xl"
                      value={customLanguage}
                      onChange={(e) => setCustomLanguage(e.target.value)}
                      placeholder='Napr. "Spanish", "Italian", "Slovenƒçina"‚Ä¶'
                    />
                  </motion.div>
                )}
              </AnimatePresence>

              <Separator />

              <div className="space-y-3">
                <SectionTitle icon={Sparkles} title="Cieƒæov√° slovn√° z√°soba" />

                <div className="flex items-center justify-between rounded-2xl border p-3">
                  <div className="space-y-0.5">
                    <div className="text-sm font-medium">Vybra≈• slovn√∫ z√°sobu automaticky</div>
                    <div className="text-xs text-muted-foreground">
                      Ak vypne≈°, zad√°≈° vlastn√© slov√≠ƒçka a zmenia sa na ≈°t√≠tky.
                    </div>
                  </div>
                  <Switch
                    checked={autoVocab}
                    onCheckedChange={(v) => setAutoVocab(!!v)}
                  />
                </div>

                <AnimatePresence>
                  {!autoVocab && (
                    <motion.div
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: "auto" }}
                      exit={{ opacity: 0, height: 0 }}
                      className="space-y-2"
                    >
                      <Label>Slov√≠ƒçka (oddelen√© ƒçiarkou)</Label>
                      <ChipInput
                        value={vocabRaw}
                        onChange={setVocabRaw}
                        tags={vocabTags}
                        setTags={setVocabTags}
                        placeholder="napr. habit, routine, stress, feedback"
                      />
                      <div className="flex items-center gap-2">
                        <Button
                          variant="secondary"
                          className="rounded-2xl"
                          onClick={() => {
                            const newTags = splitToTags(vocabRaw);
                            setVocabTags(uniq([...vocabTags, ...newTags]));
                            setVocabRaw("");
                          }}
                        >
                          Prida≈•
                        </Button>
                        <Button
                          variant="ghost"
                          className="rounded-2xl"
                          onClick={() => setVocabTags([])}
                        >
                          <Trash2 className="mr-2 h-4 w-4" /> Vymaza≈• tagy
                        </Button>
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>

              <Separator />

              <div className="space-y-3">
                <SectionTitle icon={FileText} title="Cviƒçenia" />
                <div className="flex items-center justify-between rounded-2xl border p-3">
                  <div className="space-y-0.5">
                    <div className="text-sm font-medium">Chcem prida≈• cviƒçenia</div>
                    <div className="text-xs text-muted-foreground">
                      Vyber typy aktiv√≠t a vygeneruje sa aj kƒæ√∫ƒç odpoved√≠.
                    </div>
                  </div>
                  <Switch
                    checked={wantExercises}
                    onCheckedChange={(v) => setWantExercises(!!v)}
                  />
                </div>

                <AnimatePresence>
                  {wantExercises && (
                    <motion.div
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: "auto" }}
                      exit={{ opacity: 0, height: 0 }}
                      className="grid grid-cols-1 gap-2 md:grid-cols-2"
                    >
                      {EXERCISE_TYPES.map((t) => (
                        <label
                          key={t.key}
                          className="flex items-center gap-3 rounded-2xl border p-3 hover:bg-muted/40"
                        >
                          <Checkbox
                            checked={exerciseTypes.includes(t.key)}
                            onCheckedChange={() => toggleExercise(t.key)}
                          />
                          <span className="text-sm">{t.label}</span>
                        </label>
                      ))}
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>

              <Separator />

              <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div className="text-xs text-muted-foreground">
                  <span className="font-medium text-foreground">Aktu√°lny jazyk:</span> {langLabel}
                  {" ¬∑ "}
                  <span className="font-medium text-foreground">Prompt:</span>{" "}
                  <button
                    className="underline underline-offset-4 hover:opacity-80"
                    onClick={() => setPromptOpen(true)}
                  >
                    zobrazi≈•
                  </button>
                </div>

                <Button
                  className="rounded-2xl"
                  onClick={handleGenerate}
                  disabled={!canGenerate || isLoading}
                >
                  {isLoading ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" /> Generujem‚Ä¶
                    </>
                  ) : (
                    <>
                      <Sparkles className="mr-2 h-4 w-4" /> Generova≈•
                    </>
                  )}
                </Button>
              </div>

              {!canGenerate && (
                <div className="rounded-2xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
                  <div className="flex items-start gap-2">
                    <AlertTriangle className="mt-0.5 h-4 w-4" />
                    <div>
                      Skontroluj povinn√© polia: t√©ma, vlastn√Ω jazyk (ak je zvolen√Ω),
                      slovn√° z√°soba (ak nie je automatick√°), typy cviƒçen√≠ (ak s√∫ zapnut√©).
                    </div>
                  </div>
                </div>
              )}

              {error && (
                <div className="rounded-2xl border border-red-200 bg-red-50 p-3 text-sm text-red-900">
                  {error}
                </div>
              )}
            </CardContent>
          </Card>

          {/* RIGHT: OUTPUT */}
          <Card className="rounded-2xl shadow-sm">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-base">
                <CheckCircle2 className="h-4 w-4" /> V√Ωstup
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {!generated ? (
                <div className="rounded-2xl border border-dashed p-6">
                  <div className="text-sm text-muted-foreground">
                    Tu sa zobraz√≠ vygenerovan√Ω text, slovn√° z√°soba, cviƒçenia a kƒæ√∫ƒç.
                  </div>
                  <div className="mt-3 text-xs text-muted-foreground">
                    Tip: Pre r√Ωchle testovanie nechaj zapnut√∫ automatick√∫ slovn√∫ z√°sobu a
                    zvoƒæ 2‚Äì3 typy cviƒçen√≠.
                  </div>
                </div>
              ) : (
                <motion.div
                  initial={{ opacity: 0, y: 8 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="space-y-4"
                >
                  <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                      <div className="text-lg font-semibold tracking-tight">
                        {generated.title}
                      </div>
                      <div className="text-sm text-muted-foreground">
                        {generated.languageLabel} ¬∑ CEFR {generated.cefr} ¬∑ ~{generated.lengthWords} slov
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      <Button
                        variant="secondary"
                        className="rounded-2xl"
                        onClick={handleCopy}
                      >
                        <Copy className="mr-2 h-4 w-4" /> Kop√≠rova≈•
                      </Button>
                      <Button
                        variant="secondary"
                        className="rounded-2xl"
                        onClick={() => handleExport("pdf")}
                      >
                        <Download className="mr-2 h-4 w-4" /> PDF
                      </Button>
                      <Button
                        variant="secondary"
                        className="rounded-2xl"
                        onClick={() => handleExport("docx")}
                      >
                        <Download className="mr-2 h-4 w-4" /> DOCX
                      </Button>
                      <Button
                        variant="ghost"
                        className="rounded-2xl"
                        onClick={handleClear}
                      >
                        <Trash2 className="mr-2 h-4 w-4" /> Vymaza≈•
                      </Button>
                    </div>
                  </div>

                  <Separator />

                  <div className="space-y-2">
                    <div className="text-sm font-semibold">Text</div>
                    <div className="whitespace-pre-wrap rounded-2xl border p-4 text-sm leading-relaxed">
                      {generated.passage}
                    </div>
                  </div>

                  <div className="space-y-2">
                    <div className="text-sm font-semibold">Slovn√° z√°soba</div>
                    <div className="flex flex-wrap gap-2">
                      {generated.vocabulary.map((w) => (
                        <Badge key={w} variant="secondary" className="rounded-2xl">
                          {w}
                        </Badge>
                      ))}
                    </div>
                  </div>

                  {generated.exercises && (
                    <div className="space-y-3">
                      <div className="text-sm font-semibold">Cviƒçenia</div>
                      <div className="space-y-3">
                        {Object.entries(generated.exercises).map(([k, payload]: any) => {
                          const label =
                            EXERCISE_TYPES.find((x) => x.key === k)?.label || k;
                          return (
                            <div key={k} className="rounded-2xl border p-4">
                              <div className="mb-2 text-sm font-semibold">
                                {label}
                              </div>
                              <div className="text-sm text-muted-foreground">
                                {payload.instruction}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {generated.answerKey && (
                    <div className="space-y-2">
                      <div className="text-sm font-semibold">Kƒæ√∫ƒç odpoved√≠</div>
                      <div className="rounded-2xl border p-4 text-xs">
                        <pre className="overflow-auto whitespace-pre-wrap">
{JSON.stringify(generated.answerKey, null, 2)}
                        </pre>
                      </div>
                    </div>
                  )}
                </motion.div>
              )}
            </CardContent>
          </Card>
        </div>

        <Dialog open={promptOpen} onOpenChange={setPromptOpen}>
          <DialogContent className="max-w-3xl rounded-2xl">
            <DialogHeader>
              <DialogTitle>Prompt, ktor√Ω sa po≈°le do LLM</DialogTitle>
            </DialogHeader>
            <div className="space-y-3">
              <div className="rounded-2xl border p-4 text-sm">
                <pre className="whitespace-pre-wrap leading-relaxed">
{computedPrompt}
                </pre>
              </div>
              <div className="flex justify-end gap-2">
                <Button
                  variant="secondary"
                  className="rounded-2xl"
                  onClick={() => {
                    navigator.clipboard.writeText(computedPrompt);
                  }}
                >
                  <Copy className="mr-2 h-4 w-4" /> Kop√≠rova≈• prompt
                </Button>
                <Button className="rounded-2xl" onClick={() => setPromptOpen(false)}>
                  Zavrie≈•
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>

        <div className="mt-8 rounded-2xl border bg-muted/20 p-5 text-sm">
          <div className="font-semibold">Pozn√°mka k produkcii (prakticky):</div>
          <ul className="mt-2 list-disc space-y-1 pl-5 text-muted-foreground">
            <li>
              Pridaj server endpoint <code>/api/generate</code> (Next.js route),
              ktor√Ω zavol√° LLM a vr√°ti ≈°trukt√∫rovan√Ω JSON.
            </li>
            <li>
              Export PDF/DOCX rie≈° server-side (najspoƒæahlivej≈°ie), aby bol layout
              identick√Ω v ka≈ædom prehliadaƒçi.
            </li>
            <li>
              Ak chce≈°, dopln√≠m aj ≈°abl√≥nu pracovn√©ho listu (header, meno, d√°tum,
              QR k√≥d, str√°nkovanie) a ‚Äûteacher/student‚Äú verziu.
            </li>
          </ul>
        </div>
      </div>
    </div>
  );
}
